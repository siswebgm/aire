-- =============================================
-- CRIAR 12 PORTAS POR GAVETEIRO
-- Números SEQUENCIAIS por condomínio (não repetem)
-- Execute APÓS criar_tabelas_cobrancas.sql e dados_teste_cobrancas.sql
-- =============================================

-- 1. Deletar portas existentes (para recriar)
DELETE FROM cobrancas.gvt_portas;

-- =============================================
-- CONDOMÍNIO CENTRAL (11111111)
-- Gaveteiro 1: portas 1-12
-- Gaveteiro 2: portas 13-24
-- =============================================

-- 2. PORTARIA PRINCIPAL (aaaa1111) - portas 1 a 12
INSERT INTO cobrancas.gvt_portas (condominio_uid, gaveteiro_uid, numero_porta, status_atual, ocupado_em) VALUES
  ('11111111-1111-1111-1111-111111111111', 'aaaa1111-1111-1111-1111-111111111111', 1, 'DISPONIVEL', NULL),
  ('11111111-1111-1111-1111-111111111111', 'aaaa1111-1111-1111-1111-111111111111', 2, 'OCUPADO', NOW() - INTERVAL '2 hours'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa1111-1111-1111-1111-111111111111', 3, 'OCUPADO', NOW() - INTERVAL '30 minutes'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa1111-1111-1111-1111-111111111111', 4, 'DISPONIVEL', NULL),
  ('11111111-1111-1111-1111-111111111111', 'aaaa1111-1111-1111-1111-111111111111', 5, 'BAIXADO', NOW() - INTERVAL '1 day'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa1111-1111-1111-1111-111111111111', 6, 'DISPONIVEL', NULL),
  ('11111111-1111-1111-1111-111111111111', 'aaaa1111-1111-1111-1111-111111111111', 7, 'AGUARDANDO_RETIRADA', NOW() - INTERVAL '45 minutes'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa1111-1111-1111-1111-111111111111', 8, 'DISPONIVEL', NULL),
  ('11111111-1111-1111-1111-111111111111', 'aaaa1111-1111-1111-1111-111111111111', 9, 'OCUPADO', NOW() - INTERVAL '1 hour'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa1111-1111-1111-1111-111111111111', 10, 'DISPONIVEL', NULL),
  ('11111111-1111-1111-1111-111111111111', 'aaaa1111-1111-1111-1111-111111111111', 11, 'OCUPADO', NOW() - INTERVAL '15 minutes'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa1111-1111-1111-1111-111111111111', 12, 'DISPONIVEL', NULL);

-- 3. HALL ELEVADORES (aaaa2222) - portas 13 a 24
INSERT INTO cobrancas.gvt_portas (condominio_uid, gaveteiro_uid, numero_porta, status_atual, ocupado_em) VALUES
  ('11111111-1111-1111-1111-111111111111', 'aaaa2222-2222-2222-2222-222222222222', 13, 'DISPONIVEL', NULL),
  ('11111111-1111-1111-1111-111111111111', 'aaaa2222-2222-2222-2222-222222222222', 14, 'OCUPADO', NOW() - INTERVAL '5 hours'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa2222-2222-2222-2222-222222222222', 15, 'DISPONIVEL', NULL),
  ('11111111-1111-1111-1111-111111111111', 'aaaa2222-2222-2222-2222-222222222222', 16, 'OCUPADO', NOW() - INTERVAL '15 minutes'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa2222-2222-2222-2222-222222222222', 17, 'DISPONIVEL', NULL),
  ('11111111-1111-1111-1111-111111111111', 'aaaa2222-2222-2222-2222-222222222222', 18, 'BAIXADO', NOW() - INTERVAL '3 hours'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa2222-2222-2222-2222-222222222222', 19, 'OCUPADO', NOW() - INTERVAL '2 hours'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa2222-2222-2222-2222-222222222222', 20, 'DISPONIVEL', NULL),
  ('11111111-1111-1111-1111-111111111111', 'aaaa2222-2222-2222-2222-222222222222', 21, 'BAIXADO', NOW() - INTERVAL '6 hours'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa2222-2222-2222-2222-222222222222', 22, 'DISPONIVEL', NULL),
  ('11111111-1111-1111-1111-111111111111', 'aaaa2222-2222-2222-2222-222222222222', 23, 'OCUPADO', NOW() - INTERVAL '40 minutes'),
  ('11111111-1111-1111-1111-111111111111', 'aaaa2222-2222-2222-2222-222222222222', 24, 'DISPONIVEL', NULL);

-- =============================================
-- RESIDENCIAL PARK (22222222)
-- Gaveteiro 1: portas 1-12
-- Gaveteiro 2: portas 13-24
-- =============================================

-- 4. GUARITA ENTRADA (bbbb1111) - portas 1 a 12
INSERT INTO cobrancas.gvt_portas (condominio_uid, gaveteiro_uid, numero_porta, status_atual, ocupado_em) VALUES
  ('22222222-2222-2222-2222-222222222222', 'bbbb1111-1111-1111-1111-111111111111', 1, 'DISPONIVEL', NULL),
  ('22222222-2222-2222-2222-222222222222', 'bbbb1111-1111-1111-1111-111111111111', 2, 'DISPONIVEL', NULL),
  ('22222222-2222-2222-2222-222222222222', 'bbbb1111-1111-1111-1111-111111111111', 3, 'OCUPADO', NOW() - INTERVAL '1 hour'),
  ('22222222-2222-2222-2222-222222222222', 'bbbb1111-1111-1111-1111-111111111111', 4, 'OCUPADO', NOW() - INTERVAL '20 minutes'),
  ('22222222-2222-2222-2222-222222222222', 'bbbb1111-1111-1111-1111-111111111111', 5, 'DISPONIVEL', NULL),
  ('22222222-2222-2222-2222-222222222222', 'bbbb1111-1111-1111-1111-111111111111', 6, 'OCUPADO', NOW() - INTERVAL '4 hours'),
  ('22222222-2222-2222-2222-222222222222', 'bbbb1111-1111-1111-1111-111111111111', 7, 'DISPONIVEL', NULL),
  ('22222222-2222-2222-2222-222222222222', 'bbbb1111-1111-1111-1111-111111111111', 8, 'AGUARDANDO_RETIRADA', NOW() - INTERVAL '10 minutes'),
  ('22222222-2222-2222-2222-222222222222', 'bbbb1111-1111-1111-1111-111111111111', 9, 'DISPONIVEL', NULL),
  ('22222222-2222-2222-2222-222222222222', 'bbbb1111-1111-1111-1111-111111111111', 10, 'BAIXADO', NOW() - INTERVAL '6 hours'),
  ('22222222-2222-2222-2222-222222222222', 'bbbb1111-1111-1111-1111-111111111111', 11, 'DISPONIVEL', NULL),
  ('22222222-2222-2222-2222-222222222222', 'bbbb1111-1111-1111-1111-111111111111', 12, 'OCUPADO', NOW() - INTERVAL '35 minutes');

-- 5. ÁREA DE LAZER (bbbb2222) - portas 13 a 24
INSERT INTO cobrancas.gvt_portas (condominio_uid, gaveteiro_uid, numero_porta, status_atual, ocupado_em) VALUES
  ('22222222-2222-2222-2222-222222222222', 'bbbb2222-2222-2222-2222-222222222222', 13, 'DISPONIVEL', NULL),
  ('22222222-2222-2222-2222-222222222222', 'bbbb2222-2222-2222-2222-222222222222', 14, 'OCUPADO', NOW() - INTERVAL '45 minutes'),
  ('22222222-2222-2222-2222-222222222222', 'bbbb2222-2222-2222-2222-222222222222', 15, 'DISPONIVEL', NULL),
  ('22222222-2222-2222-2222-222222222222', 'bbbb2222-2222-2222-2222-222222222222', 16, 'DISPONIVEL', NULL),
  ('22222222-2222-2222-2222-222222222222', 'bbbb2222-2222-2222-2222-222222222222', 17, 'OCUPADO', NOW() - INTERVAL '2 hours'),
  ('22222222-2222-2222-2222-222222222222', 'bbbb2222-2222-2222-2222-222222222222', 18, 'DISPONIVEL', NULL),
  ('22222222-2222-2222-2222-222222222222', 'bbbb2222-2222-2222-2222-222222222222', 19, 'BAIXADO', NOW() - INTERVAL '5 hours'),
  ('22222222-2222-2222-2222-222222222222', 'bbbb2222-2222-2222-2222-222222222222', 20, 'DISPONIVEL', NULL),
  ('22222222-2222-2222-2222-222222222222', 'bbbb2222-2222-2222-2222-222222222222', 21, 'OCUPADO', NOW() - INTERVAL '1 hour'),
  ('22222222-2222-2222-2222-222222222222', 'bbbb2222-2222-2222-2222-222222222222', 22, 'DISPONIVEL', NULL),
  ('22222222-2222-2222-2222-222222222222', 'bbbb2222-2222-2222-2222-222222222222', 23, 'DISPONIVEL', NULL),
  ('22222222-2222-2222-2222-222222222222', 'bbbb2222-2222-2222-2222-222222222222', 24, 'AGUARDANDO_RETIRADA', NOW() - INTERVAL '20 minutes');

-- =============================================
-- EMPRESARIAL TOWER (33333333)
-- Gaveteiro 1: portas 1-12
-- Gaveteiro 2: portas 13-24
-- =============================================

-- 6. RECEPÇÃO TÉRREO (cccc1111) - portas 1 a 12
INSERT INTO cobrancas.gvt_portas (condominio_uid, gaveteiro_uid, numero_porta, status_atual, ocupado_em) VALUES
  ('33333333-3333-3333-3333-333333333333', 'cccc1111-1111-1111-1111-111111111111', 1, 'DISPONIVEL', NULL),
  ('33333333-3333-3333-3333-333333333333', 'cccc1111-1111-1111-1111-111111111111', 2, 'OCUPADO', NOW() - INTERVAL '3 hours'),
  ('33333333-3333-3333-3333-333333333333', 'cccc1111-1111-1111-1111-111111111111', 3, 'OCUPADO', NOW() - INTERVAL '1 hour'),
  ('33333333-3333-3333-3333-333333333333', 'cccc1111-1111-1111-1111-111111111111', 4, 'DISPONIVEL', NULL),
  ('33333333-3333-3333-3333-333333333333', 'cccc1111-1111-1111-1111-111111111111', 5, 'OCUPADO', NOW() - INTERVAL '30 minutes'),
  ('33333333-3333-3333-3333-333333333333', 'cccc1111-1111-1111-1111-111111111111', 6, 'DISPONIVEL', NULL),
  ('33333333-3333-3333-3333-333333333333', 'cccc1111-1111-1111-1111-111111111111', 7, 'BAIXADO', NOW() - INTERVAL '2 hours'),
  ('33333333-3333-3333-3333-333333333333', 'cccc1111-1111-1111-1111-111111111111', 8, 'DISPONIVEL', NULL),
  ('33333333-3333-3333-3333-333333333333', 'cccc1111-1111-1111-1111-111111111111', 9, 'OCUPADO', NOW() - INTERVAL '4 hours'),
  ('33333333-3333-3333-3333-333333333333', 'cccc1111-1111-1111-1111-111111111111', 10, 'DISPONIVEL', NULL),
  ('33333333-3333-3333-3333-333333333333', 'cccc1111-1111-1111-1111-111111111111', 11, 'AGUARDANDO_RETIRADA', NOW() - INTERVAL '25 minutes'),
  ('33333333-3333-3333-3333-333333333333', 'cccc1111-1111-1111-1111-111111111111', 12, 'DISPONIVEL', NULL);

-- 7. SALA DE ENCOMENDAS (cccc2222) - portas 13 a 24
INSERT INTO cobrancas.gvt_portas (condominio_uid, gaveteiro_uid, numero_porta, status_atual, ocupado_em) VALUES
  ('33333333-3333-3333-3333-333333333333', 'cccc2222-2222-2222-2222-222222222222', 13, 'OCUPADO', NOW() - INTERVAL '8 hours'),
  ('33333333-3333-3333-3333-333333333333', 'cccc2222-2222-2222-2222-222222222222', 14, 'OCUPADO', NOW() - INTERVAL '6 hours'),
  ('33333333-3333-3333-3333-333333333333', 'cccc2222-2222-2222-2222-222222222222', 15, 'OCUPADO', NOW() - INTERVAL '2 hours'),
  ('33333333-3333-3333-3333-333333333333', 'cccc2222-2222-2222-2222-222222222222', 16, 'DISPONIVEL', NULL),
  ('33333333-3333-3333-3333-333333333333', 'cccc2222-2222-2222-2222-222222222222', 17, 'OCUPADO', NOW() - INTERVAL '1 hour'),
  ('33333333-3333-3333-3333-333333333333', 'cccc2222-2222-2222-2222-222222222222', 18, 'BAIXADO', NOW() - INTERVAL '30 minutes'),
  ('33333333-3333-3333-3333-333333333333', 'cccc2222-2222-2222-2222-222222222222', 19, 'DISPONIVEL', NULL),
  ('33333333-3333-3333-3333-333333333333', 'cccc2222-2222-2222-2222-222222222222', 20, 'OCUPADO', NOW() - INTERVAL '45 minutes'),
  ('33333333-3333-3333-3333-333333333333', 'cccc2222-2222-2222-2222-222222222222', 21, 'DISPONIVEL', NULL),
  ('33333333-3333-3333-3333-333333333333', 'cccc2222-2222-2222-2222-222222222222', 22, 'OCUPADO', NOW() - INTERVAL '3 hours'),
  ('33333333-3333-3333-3333-333333333333', 'cccc2222-2222-2222-2222-222222222222', 23, 'BAIXADO', NOW() - INTERVAL '4 hours'),
  ('33333333-3333-3333-3333-333333333333', 'cccc2222-2222-2222-2222-222222222222', 24, 'DISPONIVEL', NULL);

-- 8. ATUALIZAR finalizado_em para portas baixadas
UPDATE cobrancas.gvt_portas
SET finalizado_em = ocupado_em + INTERVAL '1 hour'
WHERE status_atual = 'BAIXADO'
  AND finalizado_em IS NULL;

-- =============================================
-- VERIFICAÇÃO: Deve mostrar 12 portas por gaveteiro
-- =============================================
SELECT 
  c.nome AS condominio,
  g.nome AS gaveteiro,
  COUNT(*) AS total_portas,
  COUNT(*) FILTER (WHERE p.status_atual = 'DISPONIVEL') AS disponiveis,
  COUNT(*) FILTER (WHERE p.status_atual = 'OCUPADO') AS ocupadas,
  COUNT(*) FILTER (WHERE p.status_atual = 'BAIXADO') AS baixadas,
  COUNT(*) FILTER (WHERE p.status_atual = 'AGUARDANDO_RETIRADA') AS aguardando
FROM cobrancas.gvt_condominios c
JOIN cobrancas.gvt_gaveteiros g ON g.condominio_uid = c.uid
JOIN cobrancas.gvt_portas p ON p.gaveteiro_uid = g.uid
GROUP BY c.nome, g.nome
ORDER BY c.nome, g.nome;
